name: Muses Backend CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle ÎπåÎìú
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test
          ls -l build/libs/

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üßπ Î∞∞Ìè¨ ÎîîÎ†âÌÜ†Î¶¨ Ï†ïÎ¶¨ Ï§ë..."
            sudo rm -rf /home/ubuntu/muses/*.jar
            mkdir -p /home/ubuntu/muses
            sudo chown -R ubuntu:ubuntu /home/ubuntu/muses
            chmod 755 /home/ubuntu/muses
            echo "‚úÖ ÎîîÎ†âÌÜ†Î¶¨ Ï§ÄÎπÑ ÏôÑÎ£å"
            ls -la /home/ubuntu/muses/

      # JAR ÌååÏùºÏùÑ EC2Î°ú Ï†ÑÏÜ°
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/home/ubuntu/muses"
          strip_components: 2
          overwrite: true

      # EC2ÏóêÏÑú Í∏∞Ï°¥ ÏÑúÎ≤Ñ Ï£ΩÏù¥Í≥† ÏÉà ÏÑúÎ≤Ñ Ïã§Ìñâ
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        env:
          RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
          RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          TOSS_SECRET_KEY: ${{ secrets.TOSS_SECRET_KEY }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: RDS_USERNAME,RDS_PASSWORD,JWT_SECRET,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,TOSS_SECRET_KEY,AWS_ACCESS_KEY,AWS_SECRET_KEY,S3_BUCKET_NAME
          script: |
            # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±
            cat > /home/ubuntu/muses/deploy.sh << 'DEPLOY_SCRIPT'
            #!/bin/bash
            cd /home/ubuntu/muses
            
            # Í∏∞Ï°¥ ÌîÑÎ°úÏÑ∏Ïä§ PID ÌååÏùºÎ°ú Í¥ÄÎ¶¨
            if [ -f app.pid ]; then
              OLD_PID=$(cat app.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                echo "üîÑ Í∏∞Ï°¥ ÌîÑÎ°úÏÑ∏Ïä§($OLD_PID) Ï¢ÖÎ£å Ï§ë..."
                kill $OLD_PID 2>/dev/null
                sleep 5
                kill -9 $OLD_PID 2>/dev/null || true
              fi
              rm -f app.pid
            fi
            
            # Ï∂îÍ∞ÄÎ°ú 8080 Ìè¨Ìä∏ ÏÇ¨Ïö© ÌîÑÎ°úÏÑ∏Ïä§ ÌôïÏù∏
            PORT_PID=$(lsof -t -i:8080 2>/dev/null || true)
            if [ -n "$PORT_PID" ]; then
              echo "üîÑ 8080 Ìè¨Ìä∏ ÏÇ¨Ïö© ÌîÑÎ°úÏÑ∏Ïä§($PORT_PID) Ï¢ÖÎ£å Ï§ë..."
              kill $PORT_PID 2>/dev/null || true
              sleep 3
            fi
            
            sleep 2
            
            # Ïã§Ìñâ
            echo "üöÄ ÏÑúÎ≤ÑÎ•º Ïã§ÌñâÌï©ÎãàÎã§..."
            nohup env \
              RDS_USERNAME="$1" \
              RDS_PASSWORD="$2" \
              JWT_SECRET="$3" \
              GOOGLE_CLIENT_ID="$4" \
              GOOGLE_CLIENT_SECRET="$5" \
              KAKAO_CLIENT_ID="$6" \
              KAKAO_CLIENT_SECRET="$7" \
              TOSS_SECRET_KEY="$8" \
              AWS_ACCESS_KEY="$9" \
              AWS_SECRET_KEY="${10}" \
              S3_BUCKET_NAME="${11}" \
              java -jar /home/ubuntu/muses/*.jar \
              --spring.profiles.active=prod \
              > /home/ubuntu/muses/app.log 2>&1 &
            
            echo $! > app.pid
            echo "‚úÖ ÏÑúÎ≤Ñ ÏãúÏûëÎê® (PID: $(cat app.pid))"
            DEPLOY_SCRIPT
            
            chmod +x /home/ubuntu/muses/deploy.sh
            
            # Ïä§ÌÅ¨Î¶ΩÌä∏Î•º Î∞±Í∑∏ÎùºÏö¥ÎìúÎ°ú Ïã§ÌñâÌïòÍ≥† Ï¶âÏãú Ï¢ÖÎ£å
            nohup /home/ubuntu/muses/deploy.sh \
              "$RDS_USERNAME" "$RDS_PASSWORD" "$JWT_SECRET" \
              "$GOOGLE_CLIENT_ID" "$GOOGLE_CLIENT_SECRET" \
              "$KAKAO_CLIENT_ID" "$KAKAO_CLIENT_SECRET" \
              "$TOSS_SECRET_KEY" "$AWS_ACCESS_KEY" "$AWS_SECRET_KEY" "$S3_BUCKET_NAME" \
              > /home/ubuntu/muses/deploy.log 2>&1 &
            
            sleep 3
            echo "üìã Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ ÏôÑÎ£å"
            
            - name: Verify deployment
              uses: appleboy/ssh-action@master
              with:
                host: ${{ secrets.EC2_HOST }}
                username: ubuntu
                key: ${{ secrets.EC2_SSH_KEY }}
                script: |
                  sleep 10
                  echo "üìã Î∞∞Ìè¨ Î°úÍ∑∏:"
                  cat /home/ubuntu/muses/deploy.log

                  echo ""
                  echo "üìã Ïï± Î°úÍ∑∏ (ÏµúÍ∑º 30Ï§Ñ):"
                  tail -30 /home/ubuntu/muses/app.log

                  echo ""
                  if [ -f /home/ubuntu/muses/app.pid ]; then
                    PID=$(cat /home/ubuntu/muses/app.pid)
                    if ps -p $PID > /dev/null 2>&1; then
                      echo "‚ú® Î∞∞Ìè¨ ÏÑ±Í≥µ! (PID: $PID)"
                      exit 0
                    fi
                  fi

                  echo "‚ùå Î∞∞Ìè¨ Ïã§Ìå®!"
                  exit 1