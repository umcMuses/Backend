name: Muses Backend CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle 빌드
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test
          ls -l build/libs/

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "🧹 배포 디렉토리 정리 중..."
            sudo rm -rf /home/ubuntu/muses/*.jar
            mkdir -p /home/ubuntu/muses
            sudo chown -R ubuntu:ubuntu /home/ubuntu/muses
            chmod 755 /home/ubuntu/muses
            echo "✅ 디렉토리 준비 완료"
            ls -la /home/ubuntu/muses/

      # JAR 파일을 EC2로 전송
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/home/ubuntu/muses"
          strip_components: 2
          overwrite: true

      # EC2에서 기존 서버 죽이고 새 서버 실행
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        env:
          RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
          RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          TOSS_SECRET_KEY: ${{ secrets.TOSS_SECRET_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p /home/ubuntu/muses
            cd /home/ubuntu/muses
            
            echo "📁 JAR 파일 목록:"
            ls -la /home/ubuntu/muses/*.jar || echo "JAR 파일이 없습니다!"
            
            # 기존 프로세스 종료
            echo "🔄 기존 프로세스 확인 중..."
            CURRENT_PID=$(pgrep -f ".*\.jar" || true)
            if [ -n "$CURRENT_PID" ]; then
              echo "🔄 기존 프로세스($CURRENT_PID)를 종료합니다."
              kill -15 $CURRENT_PID 2>/dev/null || true
              sleep 5
              kill -9 $CURRENT_PID 2>/dev/null || true
              sleep 2
            else
              echo "✅ 실행 중인 프로세스가 없습니다."
            fi
            
            if pgrep -f ".*\.jar" > /dev/null 2>&1; then
              echo "⚠️ 프로세스가 아직 실행 중입니다. 강제 종료..."
              pkill -9 -f ".*\.jar" || true
              sleep 2
            fi
            
            # 실행
            echo "🚀 서버를 실행합니다..."
            nohup java -jar /home/ubuntu/muses/*.jar \
              --spring.profiles.active=prod \
              --RDS_USERNAME="$RDS_USERNAME" \
              --RDS_PASSWORD="$RDS_PASSWORD" \
              --JWT_SECRET="$JWT_SECRET" \
              --GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
              --GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
              --KAKAO_CLIENT_ID="$KAKAO_CLIENT_ID" \
              --KAKAO_CLIENT_SECRET="$KAKAO_CLIENT_SECRET" \
              --TOSS_SECRET_KEY="$TOSS_SECRET_KEY" \
              > /home/ubuntu/muses/app.log 2>&1 &
            
            sleep 2
            if pgrep -f "muses.*.jar" > /dev/null; then
              echo "✨ 배포 성공!"
            else
              echo "❌ 배포 실패! 로그를 확인하세요."
              cat app.log
              exit 1
            fi